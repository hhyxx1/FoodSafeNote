import { router, promptAction } from '@kit.ArkUI';
import { BarcodeService } from '../common/BarcodeService';
import { OcrRecord } from '../model/DataModels';
import { DatabaseHelper } from '../common/DatabaseHelper';
import { textRecognition } from '@kit.CoreVisionKit';
import { cameraPicker, camera } from '@kit.CameraKit';
import { image } from '@kit.ImageKit';
import { kjToKcal } from '../common/Constants';

// è·¯ç”±å‚æ•°æ¥å£
interface CaloriePageParams {
  barcode: string;
  name: string;
  category: string;
  spec: string;
}

// è·³è½¬AddFoodPageå‚æ•°æ¥å£
interface AddFoodParams {
  barcode: string;
  name: string;
  category: string;
  spec: string;
  calories: number;
  fromBarcodeScan: boolean;
}

@Entry
@Component
struct CalorieInputPage {
  @State barcode: string = '';
  @State foodName: string = '';
  @State category: string = '';
  @State spec: string = '';
  @State caloriesText: string = '';
  @State autoFillCalories: number = 0;
  @State calorieSource: string = '';
  @State calorieUnit: string = 'kJ';
  @State isLoading: boolean = true;

  aboutToAppear(): void {
    const params: CaloriePageParams = router.getParams() as CaloriePageParams;
    if (params !== null && params !== undefined) {
      this.barcode = params.barcode;
      this.foodName = params.name;
      this.category = params.category;
      this.spec = params.spec;
      this.fetchCalories();
    } else {
      this.isLoading = false;
    }
  }

  private fetchCalories(): void {
    BarcodeService.getInstance().fetchCalories(this.barcode, this.category, this.foodName)
      .then((calories: number) => {
        if (calories > 0) {
          this.autoFillCalories = calories;
          this.caloriesText = calories.toString();
          this.calorieSource = 'æ¥è‡ªæœ¬åœ°è®°å¿†';
        }
        this.isLoading = false;
      });
  }

  private async startOcrRecognition(): Promise<void> {
    try {
      const pickerProfile: cameraPicker.PickerProfile = {
        cameraPosition: camera.CameraPosition.CAMERA_POSITION_BACK
      };
      const pickerResult: cameraPicker.PickerResult =
        await cameraPicker.pick(getContext(this), [cameraPicker.PickerMediaType.PHOTO], pickerProfile);
      const imageUri: string = pickerResult.resultUri;
      if (imageUri.length === 0) {
        return;
      }
      // ä»URIåˆ›å»ºPixelMap
      const imageSource: image.ImageSource = image.createImageSource(imageUri);
      const pixelMap: image.PixelMap = await imageSource.createPixelMap();
      const visionInfo: textRecognition.VisionInfo = {
        pixelMap: pixelMap
      };
      const textResult: textRecognition.TextRecognitionResult =
        await textRecognition.recognizeText(visionInfo);
      const recognizedText: string = textResult.value;
      pixelMap.release();
      imageSource.release();
      // å°è¯•ä»è¯†åˆ«æ–‡æœ¬ä¸­æå–çƒ­é‡å€¼
      const calorieValue: number = this.parseCalorieFromText(recognizedText);
      if (calorieValue > 0) {
        this.caloriesText = calorieValue.toString();
        this.autoFillCalories = calorieValue;
        this.calorieSource = 'æ¥è‡ªOCRè¯†åˆ«';
        promptAction.showToast({ message: 'å·²è¯†åˆ«çƒ­é‡å€¼: ' + calorieValue.toString() + ' kcal', duration: 2000 });
      } else {
        promptAction.showToast({ message: 'æœªèƒ½ä»å›¾ç‰‡ä¸­è¯†åˆ«å‡ºçƒ­é‡å€¼ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥', duration: 2000 });
      }
    } catch (e) {
      promptAction.showToast({ message: 'OCRåŠŸèƒ½éœ€è¦è®¾å¤‡æ”¯æŒ', duration: 2000 });
    }
  }

  private parseCalorieFromText(text: string): number {
    // åŒ¹é…å¸¸è§è¥å…»è¡¨ä¸­çš„èƒ½é‡/çƒ­é‡å€¼
    // å°è¯•åŒ¹é… "èƒ½é‡" æˆ– "çƒ­é‡" åé¢çš„æ•°å­—
    const lines: string[] = text.split('\n');
    for (let i = 0; i < lines.length; i++) {
      const line: string = lines[i];
      if (line.indexOf('èƒ½é‡') >= 0 || line.indexOf('çƒ­é‡') >= 0 || line.indexOf('Energy') >= 0) {
        // æå–è¯¥è¡Œä¸­çš„æ•°å­—
        const num: number = this.extractNumber(line);
        if (num > 0) {
          // å¦‚æœæ˜¯kJï¼Œè½¬æ¢ä¸ºkcal (1kcal â‰ˆ 4.184kJ)
          if (line.indexOf('kJ') >= 0 || line.indexOf('åƒç„¦') >= 0) {
            return Math.round(num / 4.184);
          }
          return num;
        }
      }
    }
    return 0;
  }

  private extractNumber(text: string): number {
    let numStr: string = '';
    let foundDot: boolean = false;
    for (let i = 0; i < text.length; i++) {
      const ch: string = text.charAt(i);
      if (ch >= '0' && ch <= '9') {
        numStr = numStr + ch;
      } else if (ch === '.' && !foundDot && numStr.length > 0) {
        numStr = numStr + ch;
        foundDot = true;
      } else if (numStr.length > 0) {
        break;
      }
    }
    if (numStr.length > 0) {
      return Number(numStr);
    }
    return 0;
  }

  private confirmAndProceed(): void {
    const rawValue: number = Number(this.caloriesText) || 0;
    const finalCalories: number = this.calorieUnit === 'kJ' ? kjToKcal(rawValue) : rawValue;

    // å¦‚æœçƒ­é‡>0ï¼Œå­˜å…¥ProductDict
    if (finalCalories > 0) {
      BarcodeService.getInstance().saveToProductDict(
        this.barcode, this.foodName, this.category,
        this.spec, finalCalories, this.autoFillCalories > 0 ? 'edited' : 'manual'
      );
    }

    // è®°å½•OCRè®°å½•ï¼ˆå³ä½¿æ²¡æœ‰ç”¨OCRï¼Œä¹Ÿè®°å½•æ‰‹åŠ¨è¾“å…¥ï¼‰
    if (finalCalories > 0 || this.autoFillCalories > 0) {
      const ocrRec = new OcrRecord();
      ocrRec.foodName = this.foodName;
      ocrRec.barcode = this.barcode;
      ocrRec.ocrValue = this.autoFillCalories;
      ocrRec.finalValue = finalCalories;
      DatabaseHelper.getInstance().insertOcrRecord(ocrRec);
    }

    // è·³è½¬åˆ°AddFoodPageå®Œæˆå…¥åº“
    const params: AddFoodParams = {
      barcode: this.barcode,
      name: this.foodName,
      category: this.category,
      spec: this.spec,
      calories: finalCalories,
      fromBarcodeScan: true
    };
    router.replaceUrl({ url: 'pages/AddFoodPage', params: params });
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›')
          .height(36)
          .fontSize(14)
          .fontColor('#007DFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        Text('çƒ­é‡è·å–')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text('').width(56)
      }
      .width('100%')
      .padding({ left: 8, right: 8, top: 8, bottom: 8 })
      .backgroundColor($r('app.color.card_background'))

      Scroll() {
        Column({ space: 16 }) {
          // é£Ÿå“ä¿¡æ¯æ‘˜è¦
          Column({ space: 8 }) {
            Text('é£Ÿå“ä¿¡æ¯')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
            this.buildInfoLine('åç§°', this.foodName)
            if (this.category.length > 0) {
              this.buildInfoLine('åˆ†ç±»', this.category)
            }
            if (this.spec.length > 0) {
              this.buildInfoLine('è§„æ ¼', this.spec)
            }
            if (this.barcode.length > 0) {
              this.buildInfoLine('æ¡ç ', this.barcode)
            }
          }
          .width('100%')
          .padding(16)
          .margin({ left: 16, right: 16, top: 16 })
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(16)

          // çƒ­é‡è¾“å…¥åŒº
          Column({ space: 12 }) {
            Text('èƒ½é‡/çƒ­é‡ï¼ˆæ¯100gï¼‰')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .width('100%')

            if (this.autoFillCalories > 0) {
              Row({ space: 6 }) {
                Text('âœ…').fontSize(14)
                Text(this.calorieSource).fontSize(13).fontColor('#34C759')
              }
            }

            // kJ/kcal å•ä½åˆ‡æ¢
            Row({ space: 0 }) {
              Text('åƒç„¦ kJï¼ˆè¥å…»è¡¨å¸¸ç”¨ï¼‰')
                .fontSize(13)
                .fontColor(this.calorieUnit === 'kJ' ? Color.White : $r('app.color.text_secondary'))
                .textAlign(TextAlign.Center).layoutWeight(1).height(34)
                .backgroundColor(this.calorieUnit === 'kJ' ? '#007DFF' : $r('app.color.chip_background'))
                .borderRadius(8)
                .onClick(() => { this.calorieUnit = 'kJ'; })
              Text('åƒå¡ kcal')
                .fontSize(13)
                .fontColor(this.calorieUnit === 'kcal' ? Color.White : $r('app.color.text_secondary'))
                .textAlign(TextAlign.Center).layoutWeight(1).height(34)
                .backgroundColor(this.calorieUnit === 'kcal' ? '#007DFF' : $r('app.color.chip_background'))
                .borderRadius(8)
                .onClick(() => { this.calorieUnit = 'kcal'; })
            }
            .width('100%').borderRadius(8).clip(true)

            Row({ space: 8 }) {
              TextInput({ text: this.caloriesText, placeholder: 'è¾“å…¥è¥å…»è¡¨ä¸Šçš„æ•°å€¼' })
                .layoutWeight(1).height(48).fontSize(18).borderRadius(8)
                .backgroundColor($r('app.color.input_background'))
                .type(InputType.Number)
                .onChange((value: string) => { this.caloriesText = value; })
              Text(this.calorieUnit).fontSize(16).fontColor($r('app.color.text_secondary'))
            }
            .width('100%')

            if (this.calorieUnit === 'kJ' && this.caloriesText.length > 0) {
              Text('â‰ˆ ' + kjToKcal(Number(this.caloriesText) || 0) + ' kcalï¼ˆè‡ªåŠ¨æ¢ç®—ï¼Œå­˜å‚¨ä¸ºåƒå¡ï¼‰')
                .fontSize(12).fontColor('#007DFF')
            }

            Button('æ‹è¥å…»è¡¨ (OCRè¯†åˆ«)')
              .width('100%').height(40).fontSize(14)
              .fontColor('#007DFF').backgroundColor('#E8F0FE').borderRadius(8)
              .onClick(() => { this.startOcrRecognition(); })

            if (this.caloriesText.length === 0 || this.caloriesText === '0') {
              Row({ space: 6 }) {
                Text('âš ï¸')
                  .fontSize(14)
                Text('æœªå½•å…¥çƒ­é‡å€¼ï¼Œå»ºè®®è¡¥å½•ç”¨äºå¥åº·ç»Ÿè®¡')
                  .fontSize(13)
                  .fontColor('#FF9500')
              }
              .width('100%')
              .padding({ top: 4, bottom: 4, left: 8, right: 8 })
              .backgroundColor('#FFF3E0')
              .borderRadius(8)
            }
          }
          .width('100%')
          .padding(16)
          .margin({ left: 16, right: 16 })
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(16)

          // æç¤ºä¿¡æ¯
          Column({ space: 8 }) {
            Text('ğŸ’¡ çƒ­é‡è·å–æ–¹å¼')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
            Text('â€¢ æŸ¥çœ‹é£Ÿå“åŒ…è£…ä¸Šçš„è¥å…»æˆåˆ†è¡¨')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
            Text('â€¢ çƒ­é‡å€¼ç¡®è®¤åå°†è‡ªåŠ¨å­˜å…¥æœ¬åœ°è®°å¿†åº“')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
            Text('â€¢ ä¸‹æ¬¡æ·»åŠ åŒç±»é£Ÿå“æ—¶å°†è‡ªåŠ¨å¡«å……')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
          }
          .width('100%')
          .padding(16)
          .margin({ left: 16, right: 16 })
          .backgroundColor('#E8F5E9')
          .borderRadius(16)
          .alignItems(HorizontalAlign.Start)

          // ç¡®è®¤æŒ‰é’®
          Button('ä¸‹ä¸€æ­¥ï¼šè®¾ç½®ä¿è´¨æœŸ')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor('#007DFF')
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 8, bottom: 32 })
            .onClick(() => {
              this.confirmAndProceed();
            })
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  buildInfoLine(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(13)
        .fontColor($r('app.color.text_hint'))
        .width(50)
      Text(value)
        .fontSize(14)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 2, bottom: 2 })
  }
}
