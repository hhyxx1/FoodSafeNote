import { router, promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { DataExportService } from '../common/DataExportService';
import { formatTimestampFull } from '../common/Constants';

@Entry
@Component
struct DataBackupPage {
  @State backupFiles: string[] = [];
  @State isExporting: boolean = false;
  @State isImporting: boolean = false;
  @State lastExportPath: string = '';

  aboutToAppear(): void {
    this.loadBackupFiles();
  }

  private loadBackupFiles(): void {
    this.backupFiles = DataExportService.getBackupFiles(getContext(this));
  }

  private async exportAll(): Promise<void> {
    this.isExporting = true;
    try {
      const json: string = await DataExportService.exportAllData();
      const fileName: string = 'backup_' + Date.now() + '.json';
      const path: string = await DataExportService.saveToFile(getContext(this), json, fileName);
      this.lastExportPath = path;
      promptAction.showToast({ message: 'ÂÖ®ÈáèÂ§á‰ªΩÊàêÂäü', duration: 2000 });
      this.loadBackupFiles();
    } catch (e) {
      promptAction.showToast({ message: 'ÂØºÂá∫Â§±Ë¥•', duration: 1500 });
    }
    this.isExporting = false;
  }

  private async importAll(): Promise<void> {
    this.isImporting = true;
    try {
      const ctx: common.Context = getContext(this) as common.Context;
      const dir: string = ctx.filesDir;
      const filePath: string = dir + '/import_data.json';
      const jsonStr: string = await DataExportService.readFromFile(filePath);
      const result = await DataExportService.importAllData(jsonStr);
      if (result.success) {
        promptAction.showToast({ message: 'ÂÖ®ÈáèÂØºÂÖ•ÊàêÂäü', duration: 2000 });
      } else {
        promptAction.showToast({ message: result.message, duration: 2000 });
      }
    } catch (e) {
      promptAction.showToast({ message: 'ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂‰∏çÂ≠òÂú®ÊàñÊ†ºÂºèÈîôËØØ', duration: 2000 });
    }
    this.isImporting = false;
  }

  private async exportDict(): Promise<void> {
    this.isExporting = true;
    try {
      const json: string = await DataExportService.exportProductDict();
      const fileName: string = 'dict_' + Date.now() + '.json';
      const path: string = await DataExportService.saveToFile(getContext(this), json, fileName);
      this.lastExportPath = path;
      promptAction.showToast({ message: '‰∫ßÂìÅÂ≠óÂÖ∏ÂØºÂá∫ÊàêÂäü', duration: 2000 });
      this.loadBackupFiles();
    } catch (e) {
      promptAction.showToast({ message: 'ÂØºÂá∫Â§±Ë¥•', duration: 1500 });
    }
    this.isExporting = false;
  }

  build() {
    Column() {
      // ÂØºËà™Ê†è
      Row() {
        Button('ËøîÂõû')
          .height(36).fontSize(14).fontColor('#007DFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => { router.back(); })
        Text('Êï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç')
          .fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
          .layoutWeight(1).textAlign(TextAlign.Center)
        Text('').width(56)
      }
      .width('100%')      .padding({ left: 8, right: 8, top: 8, bottom: 8 })
      .backgroundColor($r('app.color.card_background'))

      Scroll() {
        Column({ space: 16 }) {
          // ÂØºÂá∫Êìç‰Ωú
          Column({ space: 12 }) {
            Text('Êï∞ÊçÆÂØºÂá∫')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
            Text('ÂØºÂá∫Êï∞ÊçÆ‰∏∫JSONÊñá‰ª∂Ôºå‰øùÂ≠òÂú®Â∫îÁî®Ê≤ôÁÆ±ÁõÆÂΩï')
              .fontSize(13).fontColor($r('app.color.text_hint')).width('100%')

            Button('ÂÖ®ÈáèÂØºÂá∫ÔºàÈ£üÂìÅ+ÊàêÂëò+Â≠óÂÖ∏Ôºâ')
              .width('100%').height(44).fontSize(14)
              .fontColor(Color.White).backgroundColor('#007DFF').borderRadius(8)
              .enabled(!this.isExporting)
              .onClick(() => { this.exportAll(); })

            Button('‰∫ßÂìÅÂ≠óÂÖ∏ÂçïÁã¨ÂØºÂá∫')
              .width('100%').height(44).fontSize(14)
              .fontColor('#007DFF').backgroundColor('#E8F0FE').borderRadius(8)
              .enabled(!this.isExporting)
              .onClick(() => { this.exportDict(); })

            Button('ÂÖ®ÈáèÂØºÂÖ•Ôºà‰ªéÊ≤ôÁÆ±ÁõÆÂΩïÔºâ')
              .width('100%').height(44).fontSize(14)
              .fontColor(Color.White).backgroundColor('#34C759').borderRadius(8)
              .enabled(!this.isImporting)
              .onClick(() => { this.importAll(); })

            Text('ÂØºÂÖ•ËØ¥ÊòéÔºöÂ∞ÜÂ§á‰ªΩJSONÊñá‰ª∂ÈáçÂëΩÂêç‰∏∫ import_data.json ÊîæÂÖ•Â∫îÁî®Ê≤ôÁÆ±ÁõÆÂΩï')
              .fontSize(11).fontColor($r('app.color.text_hint')).width('100%')

            if (this.lastExportPath.length > 0) {
              Text('ÊúÄËøëÂØºÂá∫: ' + this.lastExportPath)
                .fontSize(11).fontColor('#34C759').width('100%')
            }
          }
          .width('100%').padding(16).margin({ left: 16, right: 16, top: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // ÂÆâÂÖ®ÊèêÁ§∫
          Column({ space: 8 }) {
            Text('üí° Êï∞ÊçÆÂÆâÂÖ®ËØ¥Êòé')
              .fontSize(14).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary'))
            Text('‚Ä¢ ÊâÄÊúâÊï∞ÊçÆ‰ªÖÂ≠òÂÇ®Âú®Êú¨Âú∞ËÆæÂ§á')
              .fontSize(13).fontColor($r('app.color.text_secondary'))
            Text('‚Ä¢ ÂØºÂá∫Êñá‰ª∂‰øùÂ≠òÂú®Â∫îÁî®Ê≤ôÁÆ±ÁõÆÂΩï')
              .fontSize(13).fontColor($r('app.color.text_secondary'))
            Text('‚Ä¢ Âç∏ËΩΩÂ∫îÁî®Â∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ')
              .fontSize(13).fontColor($r('app.color.text_secondary'))
            Text('‚Ä¢ Âª∫ËÆÆÂÆöÊúüÂØºÂá∫Â§á‰ªΩÈáçË¶ÅÊï∞ÊçÆ')
              .fontSize(13).fontColor($r('app.color.text_secondary'))
          }
          .width('100%').padding(16).margin({ left: 16, right: 16 })
          .backgroundColor('#E8F5E9').borderRadius(16)
          .alignItems(HorizontalAlign.Start)

          // Â§á‰ªΩÊñá‰ª∂ÂàóË°®
          Column({ space: 12 }) {
            Text('Â§á‰ªΩÊñá‰ª∂')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
            if (this.backupFiles.length === 0) {
              Text('ÊöÇÊó†Â§á‰ªΩÊñá‰ª∂')
                .fontSize(13).fontColor($r('app.color.text_hint')).width('100%')
                .textAlign(TextAlign.Center).padding({ top: 16, bottom: 16 })
            } else {
              ForEach(this.backupFiles, (file: string) => {
                Row() {
                  Text('üìÑ').fontSize(16).width(28)
                  Text(file).fontSize(13).fontColor($r('app.color.text_primary')).layoutWeight(1)
                }
                .width('100%').padding({ top: 6, bottom: 6 })
              }, (file: string) => file)
            }
          }
          .width('100%').padding(16).margin({ left: 16, right: 16, bottom: 32 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.page_background'))
  }
}
