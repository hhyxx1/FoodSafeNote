import { InventoryView } from '../views/InventoryView';
import { HealthView } from '../views/HealthView';
import { MineView } from '../views/MineView';
import { WatchInventoryView } from '../views/WatchInventoryView';
import { WatchHealthView } from '../views/WatchHealthView';
// WatchMineView removed - watch only has inventory + health
import { TvInventoryView } from '../views/TvInventoryView';
import { TvHealthView } from '../views/TvHealthView';
import { TvMineView } from '../views/TvMineView';
import { DatabaseHelper } from '../common/DatabaseHelper';
import { BarcodeService } from '../common/BarcodeService';
import { deviceInfo } from '@kit.BasicServicesKit';
import { pasteboard } from '@kit.BasicServicesKit';
import { preferences } from '@kit.ArkData';
import { promptAction, router } from '@kit.ArkUI';

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State refreshKey: number = 0;
  @State watchListOpen: boolean = false;
  private tabsController: TabsController = new TabsController();
  private currentDeviceType: string = deviceInfo.deviceType;

  aboutToAppear(): void {
    const ctx = getContext(this);
    DatabaseHelper.getInstance().initDB(ctx).then(() => {
      this.onDBReady(ctx);
    }).catch(() => {
      // initDBéƒ¨åˆ†å¤±è´¥ï¼ˆå¦‚åˆ†å¸ƒå¼è¡¨è®¾ç½®å¤±è´¥ï¼‰ï¼Œä½†æœ¬åœ°DBå¯èƒ½å·²å°±ç»ª
      this.onDBReady(ctx);
    });
  }

  private onDBReady(ctx: Context): void {
    // DBå°±ç»ªåŽé€šçŸ¥æ‰€æœ‰è§†å›¾åŠ è½½æ•°æ®
    this.refreshKey = this.refreshKey + 1;
    // ç›‘å¬è¿œç«¯è®¾å¤‡æ•°æ®å˜æ›´ï¼Œè‡ªåŠ¨åˆ·æ–°UI
    DatabaseHelper.getInstance().setOnRemoteChangeCallback(() => {
      this.refreshKey = this.refreshKey + 1;
    });
    // å¼‚æ­¥åˆå§‹åŒ–å†…ç½®æ¡ç åº“ï¼ˆä¸é˜»å¡žUIï¼‰
    BarcodeService.getInstance().initBuiltinLibrary(ctx);
  }

  onPageShow(): void {
    if (DatabaseHelper.getInstance().getStore() !== null) {
      this.refreshKey = this.refreshKey + 1;
      // å‰ªè´´æ¿è‡ªåŠ¨æ£€æµ‹ï¼ˆä»…æ‰‹æœº/å¹³æ¿/2in1ï¼Œä¸”å¼€å…³å¼€å¯æ—¶ï¼‰
      if (this.currentDeviceType !== 'wearable' && this.currentDeviceType !== 'tv') {
        this.checkClipboard();
      }
    }
  }

  private checkClipboard(): void {
    try {
      const store: preferences.Preferences =
        preferences.getPreferencesSync(getContext(this), { name: 'settings' });
      const enabled: boolean = store.getSync('clipboard_auto', false) as boolean;
      if (!enabled) return;
      const sysBoard: pasteboard.SystemPasteboard = pasteboard.getSystemPasteboard();
      sysBoard.getData().then((data: pasteboard.PasteData) => {
        if (data.getRecordCount() > 0) {
          const record: pasteboard.PasteDataRecord = data.getRecord(0);
          const text: string = record.plainText !== undefined ? record.plainText : '';
          if (text.length > 2 && text.length < 500) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é£Ÿå“ç›¸å…³å…³é”®è¯
            const hasKeyword: boolean = text.indexOf('ä¹°') >= 0 || text.indexOf('è´­') >= 0 ||
              text.indexOf('å…¥åº“') >= 0 || text.indexOf('é‡‡è´­') >= 0 ||
              text.indexOf('æ¸…å•') >= 0 || text.indexOf('é£Ÿ') >= 0;
            if (hasKeyword) {
              promptAction.showDialog({
                title: 'æ£€æµ‹åˆ°é£Ÿå“æ¸…å•',
                message: 'å‰ªè´´æ¿å†…å®¹å¯èƒ½åŒ…å«é£Ÿå“ä¿¡æ¯ï¼Œæ˜¯å¦æ‰¹é‡æ·»åŠ ï¼Ÿ',
                buttons: [
                  { text: 'å¿½ç•¥', color: '#999999' },
                  { text: 'åŽ»æ·»åŠ ', color: '#007DFF' }
                ]
              }).then((result: promptAction.ShowDialogSuccessResponse) => {
                if (result.index === 1) {
                  router.pushUrl({ url: 'pages/ClipboardParsePage' });
                }
              });
            }
          }
        }
      });
    } catch (e) {
      // å‰ªè´´æ¿æ£€æµ‹å¤±è´¥ä¸å½±å“ä½¿ç”¨
    }
  }

  build() {
    if (this.currentDeviceType === 'wearable') {
      this.buildWatchLayout()
    } else if (this.currentDeviceType === 'tv') {
      this.buildTvLayout()
    } else {
      // phone / tablet / 2in1 å‡ä½¿ç”¨å…¨åŠŸèƒ½å¸ƒå±€
      this.buildPhoneLayout()
    }
  }

  // æ‰‹æœº/å¹³æ¿å¸ƒå±€
  @Builder
  buildPhoneLayout() {
    Tabs({ barPosition: BarPosition.End, controller: this.tabsController }) {
      TabContent() {
        InventoryView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.phoneTabBuilder('åº“å­˜', 0, 'ðŸ“¦'))

      TabContent() {
        HealthView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.phoneTabBuilder('å¥åº·', 1, 'â¤ï¸'))

      TabContent() {
        MineView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.phoneTabBuilder('æˆ‘çš„', 2, 'ðŸ‘¤'))
    }
    .scrollable(false)
    .barHeight(60)
    .barBackgroundColor($r('app.color.tab_bar_background'))
    .onChange((index: number) => {
      this.currentIndex = index;
    })
  }

  // æ‰‹è¡¨å¸ƒå±€ - ä»…åº“å­˜+å¥åº·ä¸¤é¡µï¼ŒSwiperæ»‘åŠ¨åˆ‡æ¢
  @Builder
  buildWatchLayout() {
    Stack({ alignContent: Alignment.Top }) {
      Swiper() {
        WatchInventoryView({ refreshKey: this.refreshKey, listOpen: this.watchListOpen })
        WatchHealthView({ refreshKey: this.refreshKey })
      }
      .indicator(false)
      .loop(false)
      .disableSwipe(this.watchListOpen)
      .width('100%')
      .height('100%')
      .onChange((index: number) => {
        this.currentIndex = index;
      })

      // æŒ‡ç¤ºç‚¹ - ä»…æ€»è§ˆæ—¶æ˜¾ç¤ºï¼Œåˆ—è¡¨å±•å¼€æ—¶éšè—
      if (!this.watchListOpen) {
        Row({ space: 6 }) {
          Circle().width(5).height(5)
            .fill(this.currentIndex === 0 ? '#007DFF' : '#CCCCCC')
          Circle().width(5).height(5)
            .fill(this.currentIndex === 1 ? '#007DFF' : '#CCCCCC')
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ top: 8 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  // æ™ºæ…§å±å¸ƒå±€ - å¤§Tab
  @Builder
  buildTvLayout() {
    Tabs({ barPosition: BarPosition.End, controller: this.tabsController }) {
      TabContent() {
        TvInventoryView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.tvTabBuilder('åº“å­˜', 0, 'ðŸ“¦'))

      TabContent() {
        TvHealthView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.tvTabBuilder('å¥åº·', 1, 'â¤ï¸'))

      TabContent() {
        TvMineView({ refreshKey: this.refreshKey })
      }
      .tabBar(this.tvTabBuilder('å­—å…¸', 2, 'ðŸ“–'))
    }
    .scrollable(false)
    .barHeight(80)
    .barBackgroundColor($r('app.color.tab_bar_background'))
    .onChange((index: number) => {
      this.currentIndex = index;
    })
  }

  @Builder
  phoneTabBuilder(title: string, targetIndex: number, icon: string) {
    Column({ space: 4 }) {
      Text(icon).fontSize(22)
      Text(title)
        .fontSize(11)
        .fontWeight(this.currentIndex === targetIndex ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(this.currentIndex === targetIndex ? '#007DFF' : $r('app.color.tab_inactive'))
    }
    .width('100%').height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentIndex = targetIndex;
      this.tabsController.changeIndex(targetIndex);
    })
  }

  @Builder
  watchTabBuilder(title: string, targetIndex: number) {
    Text(title)
      .fontSize(14)
      .fontWeight(this.currentIndex === targetIndex ? FontWeight.Bold : FontWeight.Normal)
      .fontColor(this.currentIndex === targetIndex ? '#007DFF' : $r('app.color.tab_inactive'))
      .textAlign(TextAlign.Center)
      .width('100%').height('100%')
      .onClick(() => {
        this.currentIndex = targetIndex;
        this.tabsController.changeIndex(targetIndex);
      })
  }

  @Builder
  tvTabBuilder(title: string, targetIndex: number, icon: string) {
    Column({ space: 6 }) {
      Text(icon).fontSize(30)
      Text(title)
        .fontSize(18)
        .fontWeight(this.currentIndex === targetIndex ? FontWeight.Bold : FontWeight.Normal)
        .fontColor(this.currentIndex === targetIndex ? '#007DFF' : $r('app.color.tab_inactive'))
    }
    .width('100%').height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentIndex = targetIndex;
      this.tabsController.changeIndex(targetIndex);
    })
  }
}
