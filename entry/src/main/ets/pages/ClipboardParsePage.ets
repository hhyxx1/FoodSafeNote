import { router, promptAction } from '@kit.ArkUI';
import { pasteboard } from '@kit.BasicServicesKit';
import { DatabaseHelper } from '../common/DatabaseHelper';
import { FoodItem } from '../model/DataModels';
import { StorageType, calculateExpiryTimestamp } from '../common/Constants';

// è§£æå‡ºçš„é£Ÿå“æ¡ç›®
interface ParsedFoodEntry {
  name: string;
  selected: boolean;
  confidence: number;
}

@Entry
@Component
struct ClipboardParsePage {
  @State clipboardText: string = '';
  @State parsedItems: ParsedFoodEntry[] = [];
  @State manualInput: string = '';
  @State isSaving: boolean = false;

  aboutToAppear(): void {
    this.readClipboard();
  }

  private readClipboard(): void {
    try {
      const sysBoard: pasteboard.SystemPasteboard = pasteboard.getSystemPasteboard();
      sysBoard.getData().then((data: pasteboard.PasteData) => {
        if (data.getRecordCount() > 0) {
          const record: pasteboard.PasteDataRecord = data.getRecord(0);
          const text: string = record.plainText !== undefined ? record.plainText : '';
          if (text.length > 0) {
            this.clipboardText = text;
            this.parseText(text);
          }
        }
      });
    } catch (e) {
      // å‰ªè´´æ¿è¯»å–å¤±è´¥
    }
  }

  private parseText(text: string): void {
    // æŒ‰æ¢è¡Œã€é€—å·ã€é¡¿å·åˆ†å‰²
    const lines: string[] = text.split('\n');
    const items: ParsedFoodEntry[] = [];
    for (let i = 0; i < lines.length; i++) {
      const line: string = lines[i].trim();
      if (line.length === 0) continue;
      // è¿›ä¸€æ­¥æŒ‰é€—å·å’Œé¡¿å·åˆ†å‰²
      const parts: string[] = [];
      let current: string = '';
      for (let j = 0; j < line.length; j++) {
        const ch: string = line[j];
        if (ch === ',' || ch === 'ï¼Œ' || ch === 'ã€' || ch === ';' || ch === 'ï¼›') {
          if (current.trim().length > 0) {
            parts.push(current.trim());
          }
          current = '';
        } else {
          current = current + ch;
        }
      }
      if (current.trim().length > 0) {
        parts.push(current.trim());
      }
      for (let k = 0; k < parts.length; k++) {
        const name: string = parts[k];
        // è¿‡æ»¤çº¯æ•°å­—å’Œè¿‡çŸ­çš„
        if (name.length >= 1 && name.length <= 20) {
          const entry: ParsedFoodEntry = { name: name, selected: true, confidence: name.length >= 2 ? 0.9 : 0.5 };
          items.push(entry);
        }
      }
    }
    this.parsedItems = items;
  }

  private addManualItems(): void {
    const text: string = this.manualInput.trim();
    if (text.length === 0) return;
    this.parseText(text);
    this.manualInput = '';
  }

  private async batchSave(): Promise<void> {
    if (this.isSaving) return;
    this.isSaving = true;
    let savedCount: number = 0;
    const db: DatabaseHelper = DatabaseHelper.getInstance();
    for (let i = 0; i < this.parsedItems.length; i++) {
      if (this.parsedItems[i].selected) {
        const food = new FoodItem();
        food.name = this.parsedItems[i].name;
        food.storageType = StorageType.FRIDGE;
        food.expiryDate = calculateExpiryTimestamp('å…¶ä»–', StorageType.FRIDGE);
        food.status = 0;
        await db.insertFoodItem(food);
        savedCount++;
      }
    }
    this.isSaving = false;
    if (savedCount > 0) {
      promptAction.showToast({ message: 'æˆåŠŸå…¥åº“ ' + savedCount + ' ä»¶é£Ÿå“', duration: 2000 });
      router.back();
    } else {
      promptAction.showToast({ message: 'è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹', duration: 1500 });
    }
  }

  private getSelectedCount(): number {
    let count: number = 0;
    for (let i = 0; i < this.parsedItems.length; i++) {
      if (this.parsedItems[i].selected) count++;
    }
    return count;
  }

  private toggleItem(index: number): void {
    const newList: ParsedFoodEntry[] = [];
    for (let i = 0; i < this.parsedItems.length; i++) {
      const item: ParsedFoodEntry = this.parsedItems[i];
      if (i === index) {
        const toggled: ParsedFoodEntry = { name: item.name, selected: !item.selected, confidence: item.confidence };
        newList.push(toggled);
      } else {
        newList.push(item);
      }
    }
    this.parsedItems = newList;
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›')
          .height(36).fontSize(14).fontColor('#007DFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => { router.back(); })
        Text('æ‰¹é‡æ·»åŠ ')
          .fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
          .layoutWeight(1).textAlign(TextAlign.Center)
        Button('å…¥åº“ (' + this.getSelectedCount() + ')')
          .height(36).fontSize(14).fontColor(Color.White)
          .backgroundColor('#007DFF').borderRadius(8)
          .enabled(!this.isSaving && this.getSelectedCount() > 0)
          .onClick(() => { this.batchSave(); })
      }
      .width('100%').padding({ left: 8, right: 8, top: 8, bottom: 8 })
      .backgroundColor($r('app.color.card_background'))

      Scroll() {
        Column({ space: 16 }) {
          // æ‰‹åŠ¨è¾“å…¥åŒº
          Column({ space: 8 }) {
            Text('è¾“å…¥é£Ÿå“åç§°ï¼ˆç”¨é€—å·ã€é¡¿å·åˆ†éš”ï¼‰')
              .fontSize(14).fontColor($r('app.color.text_primary')).width('100%')
            Row({ space: 8 }) {
              TextInput({ text: this.manualInput, placeholder: 'å¦‚ï¼šç‰›å¥¶ã€é¢åŒ…ã€è‹¹æœã€é¸¡è›‹' })
                .layoutWeight(1).height(40).fontSize(14).borderRadius(8)
                .onChange((value: string) => { this.manualInput = value; })
              Button('è§£æ')
                .height(40).fontSize(14).fontColor(Color.White)
                .backgroundColor('#007DFF').borderRadius(8)
                .onClick(() => { this.addManualItems(); })
            }
          }
          .width('100%').padding(16).margin({ left: 16, right: 16, top: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // å‰ªè´´æ¿å†…å®¹ï¼ˆå¦‚æœ‰ï¼‰
          if (this.clipboardText.length > 0) {
            Column({ space: 8 }) {
              Text('ä»å‰ªè´´æ¿è¯†åˆ«')
                .fontSize(14).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
              Text(this.clipboardText)
                .fontSize(12).fontColor($r('app.color.text_hint'))
                .width('100%').maxLines(3).textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%').padding(16).margin({ left: 16, right: 16 })
            .backgroundColor($r('app.color.card_background')).borderRadius(16)
          }

          // è§£æç»“æœåˆ—è¡¨
          Column({ space: 8 }) {
            Text('å¾…å…¥åº“é£Ÿå“ (' + this.parsedItems.length + ')')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')

            if (this.parsedItems.length === 0) {
              Column({ space: 8 }) {
                Text('ğŸ“‹').fontSize(40)
                Text('è¾“å…¥æˆ–ç²˜è´´é£Ÿå“åˆ—è¡¨åè§£æ').fontSize(13).fontColor($r('app.color.text_hint'))
              }
              .width('100%').padding({ top: 24, bottom: 24 }).alignItems(HorizontalAlign.Center)
            } else {
              ForEach(this.parsedItems, (item: ParsedFoodEntry, index: number) => {
                Row() {
                  Checkbox()
                    .select(item.selected)
                    .selectedColor('#007DFF')
                    .onChange((value: boolean) => {
                      this.toggleItem(index);
                    })
                  Text(item.name)
                    .fontSize(15).fontColor($r('app.color.text_primary'))
                    .layoutWeight(1).padding({ left: 8 })
                  if (item.confidence < 0.8) {
                    Text('ä»…ä¾›å‚è€ƒ')
                      .fontSize(10).fontColor('#FF9500')
                      .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                      .borderRadius(4).backgroundColor('#FFF3E0')
                  }
                }
                .width('100%').padding({ top: 8, bottom: 8 })
              }, (item: ParsedFoodEntry, index: number) => index.toString())
            }
          }
          .width('100%').padding(16).margin({ left: 16, right: 16, bottom: 32 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.page_background'))
  }
}
