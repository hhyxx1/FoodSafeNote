import { router, promptAction } from '@kit.ArkUI';
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { BarcodeService } from '../common/BarcodeService';
import { DatabaseHelper } from '../common/DatabaseHelper';
import { FoodItem, BarcodeMatchResult } from '../model/DataModels';
import { StorageType, FOOD_CATEGORIES, isPackagedFood, calculateExpiryTimestamp, padZero, kjToKcal } from '../common/Constants';

// æ‰¹é‡æ¡ç›®
interface BatchItem {
  name: string;
  barcode: string;
  category: string;
  spec: string;
  calories: number;
  storageType: string;
  expiryDays: number;
  confirmed: boolean;
}

@Entry
@Component
struct BatchAddPage {
  @State items: BatchItem[] = [];
  @State currentStep: string = 'collect';
  @State editIndex: number = -1;
  @State isSaving: boolean = false;
  // ç¼–è¾‘ç”¨ä¸´æ—¶çŠ¶æ€
  @State editName: string = '';
  @State editCategory: string = '';
  @State editSpec: string = '';
  @State editCalories: string = '';
  @State editCalorieUnit: string = 'kJ';
  @State editStorage: string = StorageType.FRIDGE;

  // æ­¥éª¤1ï¼šæ‰«ç æ”¶é›†
  private startScan(): void {
    const options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: false,
      enableAlbum: true
    };
    try {
      scanBarcode.startScanForResult(getContext(this), options)
        .then((result: scanBarcode.ScanResult) => {
          const code: string = result.originalValue;
          if (code.length > 0) {
            this.matchAndAdd(code);
          }
        })
        .catch((error: BusinessError) => {
          promptAction.showToast({ message: 'æ‰«ç å–æ¶ˆ', duration: 1500 });
        });
    } catch (error) {
      promptAction.showToast({ message: 'æ‰«ç åŠŸèƒ½ä¸å¯ç”¨', duration: 1500 });
    }
  }

  private matchAndAdd(barcode: string): void {
    BarcodeService.getInstance().matchBarcodeInfo(barcode).then((result: BarcodeMatchResult) => {
      const item: BatchItem = {
        name: result.matched ? result.name : '',
        barcode: barcode,
        category: result.category,
        spec: result.spec,
        calories: result.calories,
        storageType: StorageType.FRIDGE,
        expiryDays: 7,
        confirmed: false
      };
      const newList: BatchItem[] = [];
      for (let i = 0; i < this.items.length; i++) {
        newList.push(this.items[i]);
      }
      newList.push(item);
      this.items = newList;
      if (result.matched) {
        promptAction.showToast({ message: 'å·²åŒ¹é…: ' + result.name, duration: 1500 });
      } else {
        promptAction.showToast({ message: 'æœªåŒ¹é…ï¼Œéœ€æ‰‹åŠ¨å¡«å†™åç§°', duration: 1500 });
      }
    });
  }

  // æ‰‹åŠ¨æ·»åŠ ç©ºæ¡ç›®
  private addManualItem(): void {
    const item: BatchItem = {
      name: '',
      barcode: '',
      category: '',
      spec: '',
      calories: 0,
      storageType: StorageType.FRIDGE,
      expiryDays: 7,
      confirmed: false
    };
    const newList: BatchItem[] = [];
    for (let i = 0; i < this.items.length; i++) {
      newList.push(this.items[i]);
    }
    newList.push(item);
    this.items = newList;
  }

  private removeItem(index: number): void {
    const newList: BatchItem[] = [];
    for (let i = 0; i < this.items.length; i++) {
      if (i !== index) {
        newList.push(this.items[i]);
      }
    }
    this.items = newList;
  }

  // æ‰“å¼€ç¼–è¾‘
  private openEdit(index: number): void {
    const item: BatchItem = this.items[index];
    this.editIndex = index;
    this.editName = item.name;
    this.editCategory = item.category;
    this.editSpec = item.spec;
    this.editCalories = item.calories > 0 ? item.calories.toString() : '';
    this.editStorage = item.storageType;
    this.currentStep = 'edit';
  }

  // ä¿å­˜ç¼–è¾‘
  private saveEdit(): void {
    if (this.editName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é£Ÿå“åç§°', duration: 1500 });
      return;
    }
    const newList: BatchItem[] = [];
    for (let i = 0; i < this.items.length; i++) {
      if (i === this.editIndex) {
        const rawCal: number = Number(this.editCalories) || 0;
        const finalCal: number = this.editCalorieUnit === 'kJ' ? kjToKcal(rawCal) : rawCal;
        const updated: BatchItem = {
          name: this.editName.trim(),
          barcode: this.items[i].barcode,
          category: this.editCategory,
          spec: this.editSpec,
          calories: finalCal,
          storageType: this.editStorage,
          expiryDays: this.items[i].expiryDays,
          confirmed: true
        };
        newList.push(updated);
      } else {
        newList.push(this.items[i]);
      }
    }
    this.items = newList;
    this.currentStep = 'collect';
  }

  // æ‰¹é‡å…¥åº“
  private async batchSave(): Promise<void> {
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ¡ç›®éƒ½æœ‰åç§°
    for (let i = 0; i < this.items.length; i++) {
      if (this.items[i].name.trim().length === 0) {
        promptAction.showToast({ message: 'ç¬¬ ' + (i + 1) + ' é¡¹ç¼ºå°‘åç§°ï¼Œè¯·ç‚¹å‡»ç¼–è¾‘', duration: 2000 });
        return;
      }
    }
    if (this.items.length === 0) {
      promptAction.showToast({ message: 'è¯·å…ˆæ·»åŠ é£Ÿå“', duration: 1500 });
      return;
    }
    this.isSaving = true;
    const db: DatabaseHelper = DatabaseHelper.getInstance();
    let count: number = 0;
    for (let i = 0; i < this.items.length; i++) {
      const item: BatchItem = this.items[i];
      const food = new FoodItem();
      food.name = item.name;
      food.barcode = item.barcode;
      food.category = item.category;
      food.spec = item.spec;
      food.calories = item.calories;
      food.storageType = item.storageType;
      if (isPackagedFood(item.category)) {
        food.expiryDate = Date.now() + item.expiryDays * 24 * 60 * 60 * 1000;
      } else {
        food.expiryDate = calculateExpiryTimestamp(item.category, item.storageType);
      }
      food.status = 0;
      await db.insertFoodItem(food);
      // å­˜å…¥äº§å“å­—å…¸
      if (item.barcode.length > 0) {
        await BarcodeService.getInstance().saveToProductDict(
          item.barcode, item.name, item.category, item.spec, item.calories, 'manual'
        );
      }
      count++;
    }
    this.isSaving = false;
    promptAction.showToast({ message: 'æˆåŠŸå…¥åº“ ' + count + ' ä»¶é£Ÿå“', duration: 2000 });
    router.back();
  }

  private getConfirmedCount(): number {
    let count: number = 0;
    for (let i = 0; i < this.items.length; i++) {
      if (this.items[i].confirmed && this.items[i].name.length > 0) count++;
    }
    return count;
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›')
          .height(36).fontSize(14).fontColor('#007DFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            if (this.currentStep === 'edit') {
              this.currentStep = 'collect';
            } else {
              router.back();
            }
          })
        Text(this.currentStep === 'edit' ? 'ç¼–è¾‘é£Ÿå“ä¿¡æ¯' : 'æ‰¹é‡æ·»åŠ ')
          .fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
          .layoutWeight(1).textAlign(TextAlign.Center)
        if (this.currentStep === 'collect' && this.items.length > 0) {
          Button('å…¨éƒ¨å…¥åº“')
            .height(36).fontSize(14).fontColor(Color.White)
            .backgroundColor('#007DFF').borderRadius(8)
            .enabled(!this.isSaving)
            .onClick(() => { this.batchSave(); })
        } else {
          Text('').width(70)
        }
      }
      .width('100%').padding({ left: 8, right: 8, top: 8, bottom: 8 })
      .backgroundColor($r('app.color.card_background'))

      if (this.currentStep === 'collect') {
        this.buildCollectView()
      } else {
        this.buildEditView()
      }
    }
    .width('100%').height('100%').backgroundColor($r('app.color.page_background'))
  }

  // æ”¶é›†é˜¶æ®µ
  @Builder
  buildCollectView() {
    Column() {
      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('æ‰«ç æ·»åŠ ')
          .layoutWeight(1).height(44).fontSize(14)
          .fontColor(Color.White).backgroundColor('#007DFF').borderRadius(8)
          .onClick(() => { this.startScan(); })
        Button('æ‰‹åŠ¨æ·»åŠ ')
          .layoutWeight(1).height(44).fontSize(14)
          .fontColor('#007DFF').backgroundColor('#E8F0FE').borderRadius(8)
          .onClick(() => { this.addManualItem(); })
      }
      .width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })

      Text('å·²æ·»åŠ  ' + this.items.length + ' é¡¹ï¼Œ' + this.getConfirmedCount() + ' é¡¹å·²ç¡®è®¤ä¿¡æ¯')
        .fontSize(12).fontColor($r('app.color.text_hint'))
        .width('100%').padding({ left: 16, right: 16, bottom: 8 })

      // æ¡ç›®åˆ—è¡¨
      if (this.items.length === 0) {
        Column({ space: 8 }) {
          Text('ğŸ“‹').fontSize(48)
          Text('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ é£Ÿå“').fontSize(14).fontColor($r('app.color.text_hint'))
          Text('å¯è¿ç»­æ‰«æå¤šä¸ªæ¡ç ').fontSize(12).fontColor($r('app.color.text_disabled'))
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
      } else {
        List({ space: 8 }) {
          ForEach(this.items, (item: BatchItem, index: number) => {
            ListItem() {
              Row() {
                // çŠ¶æ€æŒ‡ç¤º
                Circle().width(10).height(10)
                  .fill(item.confirmed ? '#34C759' : '#FF9500')
                  .margin({ right: 8 })

                Column({ space: 2 }) {
                  Text(item.name.length > 0 ? item.name : '(æœªå‘½åï¼Œç‚¹å‡»ç¼–è¾‘)')
                    .fontSize(15)
                    .fontColor(item.name.length > 0 ? $r('app.color.text_primary') : '#FF9500')
                    .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                  Row({ space: 8 }) {
                    if (item.barcode.length > 0) {
                      Text(item.barcode).fontSize(11).fontColor($r('app.color.text_hint'))
                    }
                    if (item.category.length > 0) {
                      Text(item.category).fontSize(11).fontColor($r('app.color.text_hint'))
                    }
                    if (item.calories > 0) {
                      Text(item.calories.toString() + 'kcal').fontSize(11).fontColor('#FF6B00')
                    }
                  }
                }
                .layoutWeight(1).alignItems(HorizontalAlign.Start)

                Button('ç¼–è¾‘')
                  .height(28).fontSize(11).fontColor('#007DFF')
                  .backgroundColor('#E8F0FE').borderRadius(6)
                  .margin({ right: 6 })
                  .onClick(() => { this.openEdit(index); })
                Button('åˆ é™¤')
                  .height(28).fontSize(11).fontColor('#FF3B30')
                  .backgroundColor('#FFEDE9').borderRadius(6)
                  .onClick(() => { this.removeItem(index); })
              }
              .width('100%').padding(12)
              .backgroundColor($r('app.color.card_background')).borderRadius(12)
            }
          }, (item: BatchItem, index: number) => index.toString() + '_' + item.name)
        }
        .width('100%').layoutWeight(1).padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%').layoutWeight(1)
  }

  // ç¼–è¾‘é˜¶æ®µï¼ˆé€ä¸ªç¼–è¾‘é£Ÿå“è¯¦æƒ…ï¼‰
  @Builder
  buildEditView() {
    Scroll() {
      Column({ space: 16 }) {
        // åç§°
        Column({ space: 6 }) {
          Row() {
            Text('é£Ÿå“åç§°').fontSize(14).fontColor($r('app.color.text_primary'))
            Text(' *').fontSize(14).fontColor('#FF3B30')
          }
          TextInput({ text: this.editName, placeholder: 'å¦‚ï¼šçº¯ç‰›å¥¶ã€è‹¹æœ' })
            .width('100%').height(44).fontSize(15).borderRadius(8)
            .backgroundColor($r('app.color.input_background'))
            .onChange((value: string) => { this.editName = value; })
        }
        .width('100%').padding({ left: 16, right: 16, top: 16 })

        // åˆ†ç±»
        Column({ space: 6 }) {
          Text('é£Ÿå“åˆ†ç±»').fontSize(14).fontColor($r('app.color.text_primary')).width('100%')
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(FOOD_CATEGORIES, (cat: string) => {
              Text(cat)
                .fontSize(13)
                .fontColor(this.editCategory === cat ? Color.White : $r('app.color.text_secondary'))
                .padding({ left: 14, right: 14, top: 8, bottom: 8 })
                .margin({ right: 8, bottom: 8 }).borderRadius(16)
                .backgroundColor(this.editCategory === cat ? '#007DFF' : $r('app.color.chip_background'))
                .onClick(() => { this.editCategory = cat; })
            }, (cat: string) => cat)
          }
        }
        .width('100%').padding({ left: 16, right: 16 })

        // è§„æ ¼
        Column({ space: 6 }) {
          Text('è§„æ ¼ï¼ˆé€‰å¡«ï¼‰').fontSize(14).fontColor($r('app.color.text_primary'))
          TextInput({ text: this.editSpec, placeholder: 'å¦‚ï¼š250mlã€500g' })
            .width('100%').height(44).fontSize(15).borderRadius(8)
            .backgroundColor($r('app.color.input_background'))
            .onChange((value: string) => { this.editSpec = value; })
        }
        .width('100%').padding({ left: 16, right: 16 })

        // çƒ­é‡ï¼ˆæ”¯æŒkJ/kcalåˆ‡æ¢ï¼‰
        Column({ space: 6 }) {
          Text('èƒ½é‡/çƒ­é‡ï¼ˆæ¯100gï¼Œé€‰å¡«ï¼‰').fontSize(14).fontColor($r('app.color.text_primary'))
          Row({ space: 0 }) {
            Text('åƒç„¦ kJ')
              .fontSize(13)
              .fontColor(this.editCalorieUnit === 'kJ' ? Color.White : $r('app.color.text_secondary'))
              .textAlign(TextAlign.Center).layoutWeight(1).height(32)
              .backgroundColor(this.editCalorieUnit === 'kJ' ? '#007DFF' : $r('app.color.chip_background'))
              .borderRadius(8)
              .onClick(() => { this.editCalorieUnit = 'kJ'; })
            Text('åƒå¡ kcal')
              .fontSize(13)
              .fontColor(this.editCalorieUnit === 'kcal' ? Color.White : $r('app.color.text_secondary'))
              .textAlign(TextAlign.Center).layoutWeight(1).height(32)
              .backgroundColor(this.editCalorieUnit === 'kcal' ? '#007DFF' : $r('app.color.chip_background'))
              .borderRadius(8)
              .onClick(() => { this.editCalorieUnit = 'kcal'; })
          }
          .width('100%').borderRadius(8).clip(true)
          Row({ space: 8 }) {
            TextInput({ text: this.editCalories, placeholder: 'è¥å…»è¡¨ä¸Šçš„æ•°å€¼' })
              .layoutWeight(1).height(44).fontSize(15).borderRadius(8)
              .backgroundColor($r('app.color.input_background'))
              .type(InputType.Number)
              .onChange((value: string) => { this.editCalories = value; })
            Text(this.editCalorieUnit).fontSize(14).fontColor($r('app.color.text_hint'))
          }
          if (this.editCalorieUnit === 'kJ' && this.editCalories.length > 0) {
            Text('â‰ˆ ' + kjToKcal(Number(this.editCalories) || 0) + ' kcalï¼ˆè‡ªåŠ¨æ¢ç®—ï¼‰')
              .fontSize(12).fontColor('#007DFF')
          }
        }
        .width('100%').padding({ left: 16, right: 16 })

        // å­˜å‚¨æ–¹å¼
        Column({ space: 6 }) {
          Text('å­˜å‚¨æ–¹å¼').fontSize(14).fontColor($r('app.color.text_primary')).width('100%')
          Row({ space: 0 }) {
            Text('å†·è—').fontSize(14).textAlign(TextAlign.Center).layoutWeight(1).height(40)
              .fontColor(this.editStorage === StorageType.FRIDGE ? Color.White : $r('app.color.text_secondary'))
              .backgroundColor(this.editStorage === StorageType.FRIDGE ? '#007DFF' : $r('app.color.chip_background'))
              .onClick(() => { this.editStorage = StorageType.FRIDGE; })
            Text('å†·å†»').fontSize(14).textAlign(TextAlign.Center).layoutWeight(1).height(40)
              .fontColor(this.editStorage === StorageType.FREEZER ? Color.White : $r('app.color.text_secondary'))
              .backgroundColor(this.editStorage === StorageType.FREEZER ? '#007DFF' : $r('app.color.chip_background'))
              .onClick(() => { this.editStorage = StorageType.FREEZER; })
            Text('å¸¸æ¸©').fontSize(14).textAlign(TextAlign.Center).layoutWeight(1).height(40)
              .fontColor(this.editStorage === StorageType.ROOM ? Color.White : $r('app.color.text_secondary'))
              .backgroundColor(this.editStorage === StorageType.ROOM ? '#007DFF' : $r('app.color.chip_background'))
              .onClick(() => { this.editStorage = StorageType.ROOM; })
          }
          .width('100%').borderRadius(8).clip(true)
        }
        .width('100%').padding({ left: 16, right: 16 })

        // ç¡®è®¤æŒ‰é’®
        Button('ç¡®è®¤ä¿¡æ¯')
          .width('100%').height(48).fontSize(16)
          .fontColor(Color.White).backgroundColor('#007DFF').borderRadius(12)
          .margin({ left: 16, right: 16, top: 8, bottom: 32 })
          .onClick(() => { this.saveEdit(); })
      }
    }
    .layoutWeight(1).scrollBar(BarState.Off)
  }
}
