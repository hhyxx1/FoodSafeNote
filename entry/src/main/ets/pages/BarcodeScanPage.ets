import { router, promptAction } from '@kit.ArkUI';
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { BarcodeService } from '../common/BarcodeService';
import { BarcodeMatchResult } from '../model/DataModels';

// æ¡ç æ ¡éªŒå¼¹çª—å‚æ•°æŽ¥å£
interface BarcodeVerifyResult {
  confirmed: boolean;
  name: string;
  category: string;
  spec: string;
}

// è·¯ç”±å‚æ•°æŽ¥å£
interface CaloriePageParams {
  barcode: string;
  name: string;
  category: string;
  spec: string;
}

@Entry
@Component
struct BarcodeScanPage {
  @State barcodeInput: string = '';
  @State isMatching: boolean = false;
  @State showVerifyDialog: boolean = false;
  @State matchedName: string = '';
  @State matchedCategory: string = '';
  @State matchedSpec: string = '';
  @State currentBarcode: string = '';
  @State matchSource: string = '';

  // è°ƒç”¨ç³»ç»Ÿæ‰«ç 
  private startScan(): void {
    const options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: false,
      enableAlbum: true
    };
    try {
      scanBarcode.startScanForResult(getContext(this), options)
        .then((result: scanBarcode.ScanResult) => {
          const code: string = result.originalValue;
          if (code.length > 0) {
            this.barcodeInput = code;
            this.handleBarcodeMatch(code);
          }
        })
        .catch((error: BusinessError) => {
          promptAction.showToast({ message: 'æ‰«ç å–æ¶ˆæˆ–å¤±è´¥', duration: 1500 });
        });
    } catch (error) {
      promptAction.showToast({ message: 'æ‰«ç åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¡ç ', duration: 2000 });
    }
  }

  // æ¡ç åŒ¹é…
  private handleBarcodeMatch(barcode: string): void {
    this.isMatching = true;
    this.currentBarcode = barcode;
    BarcodeService.getInstance().matchBarcodeInfo(barcode).then((result: BarcodeMatchResult) => {
      this.isMatching = false;
      if (result.matched) {
        this.matchedName = result.name;
        this.matchedCategory = result.category;
        this.matchedSpec = result.spec;
        this.matchSource = result.source;
      } else {
        this.matchedName = '';
        this.matchedCategory = '';
        this.matchedSpec = '';
        this.matchSource = '';
      }
      this.showVerifyDialog = true;
    });
  }

  // ç¡®è®¤åŽè·³è½¬çƒ­é‡é¡µ
  private confirmAndProceed(): void {
    if (this.matchedName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å•†å“åç§°', duration: 1500 });
      return;
    }
    // å­˜å…¥ProductDict
    const source: string = this.matchSource === 'product_dict' ? 'edited' : 'manual';
    BarcodeService.getInstance().saveToProductDict(
      this.currentBarcode, this.matchedName.trim(),
      this.matchedCategory, this.matchedSpec, 0, source
    );
    this.showVerifyDialog = false;
    // è·³è½¬åˆ°çƒ­é‡èŽ·å–é¡µ
    const params: CaloriePageParams = {
      barcode: this.currentBarcode,
      name: this.matchedName.trim(),
      category: this.matchedCategory,
      spec: this.matchedSpec
    };
    router.pushUrl({ url: 'pages/CalorieInputPage', params: params });
  }

  build() {
    Stack() {
      Column() {
        // å¯¼èˆªæ 
        Row() {
          Button('è¿”å›ž')
            .height(36)
            .fontSize(14)
            .fontColor('#007DFF')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              router.back();
            })
          Text('æ‰«ç å…¥åº“')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          Text('').width(56)
        }
        .width('100%')
        .padding({ left: 8, right: 8, top: 8, bottom: 8 })
        .backgroundColor($r('app.color.card_background'))

        Column({ space: 24 }) {
          // æ‰«ç æŒ‰é’®
          Column({ space: 12 }) {
            Text('ðŸ“·')
              .fontSize(56)
            Button('ç‚¹å‡»æ‰«ç ')
              .width(200)
              .height(48)
              .fontSize(16)
              .fontColor(Color.White)
              .backgroundColor('#007DFF')
              .borderRadius(24)
              .onClick(() => {
                this.startScan();
              })
            Text('å¯¹å‡†å•†å“æ¡ç å³å¯è¯†åˆ«')
              .fontSize(13)
              .fontColor($r('app.color.text_hint'))
          }
          .width('100%')
          .padding({ top: 40, bottom: 24 })
          .alignItems(HorizontalAlign.Center)

          // åˆ†éš”çº¿
          Row() {
            Divider().layoutWeight(1).color('#E0E0E0')
            Text('  æˆ–æ‰‹åŠ¨è¾“å…¥æ¡ç   ')
              .fontSize(13)
              .fontColor($r('app.color.text_hint'))
            Divider().layoutWeight(1).color('#E0E0E0')
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          // æ‰‹åŠ¨è¾“å…¥
          Row({ space: 8 }) {
            TextInput({ text: this.barcodeInput, placeholder: 'è¾“å…¥å•†å“æ¡ç ï¼ˆå¦‚ 6901234567890ï¼‰' })
              .layoutWeight(1)
              .height(44)
              .fontSize(15)
              .borderRadius(8)
              .backgroundColor($r('app.color.input_background'))
              .type(InputType.Number)
              .onChange((value: string) => {
                this.barcodeInput = value;
              })
            Button('åŒ¹é…')
              .height(44)
              .fontSize(14)
              .fontColor(Color.White)
              .backgroundColor('#007DFF')
              .borderRadius(8)
              .enabled(!this.isMatching && this.barcodeInput.trim().length > 0)
              .onClick(() => {
                this.handleBarcodeMatch(this.barcodeInput.trim());
              })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          if (this.isMatching) {
            Row({ space: 8 }) {
              LoadingProgress().width(20).height(20)
              Text('æ­£åœ¨åŒ¹é…æ¡ç ...')
                .fontSize(14)
                .fontColor($r('app.color.text_hint'))
            }
          }
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))

      // æ¡ç ä¿¡æ¯æ ¡éªŒå¼¹çª—
      if (this.showVerifyDialog) {
        Column() {
          // é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('#80000000')
            .onClick(() => {
              this.showVerifyDialog = false;
            })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })

        Column({ space: 16 }) {
          // æ ‡é¢˜
          Text(this.matchSource.length > 0 ? 'æ¡ç ä¿¡æ¯æ ¡éªŒï¼ˆå¯ä¿®æ”¹ï¼‰' : 'æ¡ç æ— åŒ¹é…ï¼Œå½•å…¥å•†å“ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .width('100%')

          // æ¡ç ï¼ˆä¸å¯ä¿®æ”¹ï¼‰
          Column({ space: 4 }) {
            Text('æ¡ç ')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
            Text(this.currentBarcode)
              .fontSize(15)
              .fontColor($r('app.color.text_hint'))
              .width('100%')
              .height(40)
              .padding({ left: 12 })
              .backgroundColor($r('app.color.chip_background'))
              .borderRadius(8)
          }

          // å•†å“åç§°ï¼ˆå¿…å¡«ï¼‰
          Column({ space: 4 }) {
            Row() {
              Text('å•†å“åç§°')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
              Text(' *')
                .fontSize(13)
                .fontColor('#FF3B30')
            }
            TextInput({ text: this.matchedName, placeholder: 'å¦‚ï¼šçº¯ç‰›å¥¶ã€åŽŸå‘³è–¯ç‰‡' })
              .width('100%')
              .height(40)
              .fontSize(14)
              .borderRadius(8)
              .backgroundColor($r('app.color.input_background'))
              .onChange((value: string) => {
                this.matchedName = value;
              })
          }

          // å“ç±»
          Column({ space: 4 }) {
            Text('å•†å“å“ç±»ï¼ˆé€‰å¡«ï¼‰')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
            TextInput({ text: this.matchedCategory, placeholder: 'å¦‚ï¼šä¹³åˆ¶å“ã€é›¶é£Ÿ' })
              .width('100%')
              .height(40)
              .fontSize(14)
              .borderRadius(8)
              .backgroundColor($r('app.color.input_background'))
              .onChange((value: string) => {
                this.matchedCategory = value;
              })
          }

          // è§„æ ¼
          Column({ space: 4 }) {
            Text('å•†å“è§„æ ¼ï¼ˆé€‰å¡«ï¼‰')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
            TextInput({ text: this.matchedSpec, placeholder: 'å¦‚ï¼š250mlã€100g' })
              .width('100%')
              .height(40)
              .fontSize(14)
              .borderRadius(8)
              .backgroundColor($r('app.color.input_background'))
              .onChange((value: string) => {
                this.matchedSpec = value;
              })
          }

          // æŒ‰é’®
          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .height(44)
              .fontSize(15)
              .fontColor($r('app.color.text_secondary'))
              .backgroundColor($r('app.color.chip_background'))
              .borderRadius(8)
              .onClick(() => {
                this.showVerifyDialog = false;
              })
            Button('ç¡®è®¤')
              .layoutWeight(1)
              .height(44)
              .fontSize(15)
              .fontColor(Color.White)
              .backgroundColor('#007DFF')
              .borderRadius(8)
              .onClick(() => {
                this.confirmAndProceed();
              })
          }
          .width('100%')
        }
        .width('85%')
        .padding(20)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(16)
        .position({ x: '7.5%', y: '20%' })
      }
    }
    .width('100%')
    .height('100%')
  }
}
