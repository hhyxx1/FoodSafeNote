import { router, promptAction } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { DatabaseHelper } from '../common/DatabaseHelper';
import { BarcodeService } from '../common/BarcodeService';
import { FamilyMember, FoodStats } from '../model/DataModels';

@Component
export struct MineView {
  @Prop @Watch('onRefreshKeyChange') refreshKey: number = 0;
  @State members: FamilyMember[] = [];
  @State newMemberName: string = '';
  @State stats: FoodStats = new FoodStats();
  @State builtinCount: number = 0;
  @State dictCount: number = 0;
  @State clipboardAutoEnabled: boolean = false;

  aboutToAppear(): void {
    if (DatabaseHelper.getInstance().getStore() !== null) {
      this.loadData();
    }
  }

  onRefreshKeyChange(): void {
    this.loadData();
  }

  private loadData(): void {
    DatabaseHelper.getInstance().getAllMembers().then((members: FamilyMember[]) => {
      this.members = members;
    });
    DatabaseHelper.getInstance().getFoodStats().then((stats: FoodStats) => {
      this.stats = stats;
    });
    DatabaseHelper.getInstance().getBuiltinBarcodeCount().then((count: number) => {
      this.builtinCount = count;
    });
    DatabaseHelper.getInstance().getProductDictCount().then((count: number) => {
      this.dictCount = count;
    });
    // è¯»å–å‰ªè´´æ¿å¼€å…³è®¾ç½®
    try {
      const store: preferences.Preferences =
        preferences.getPreferencesSync(getContext(this), { name: 'settings' });
      this.clipboardAutoEnabled = store.getSync('clipboard_auto', false) as boolean;
    } catch (e) {
      this.clipboardAutoEnabled = false;
    }
  }

  private toggleClipboard(value: boolean): void {
    this.clipboardAutoEnabled = value;
    try {
      const store: preferences.Preferences =
        preferences.getPreferencesSync(getContext(this), { name: 'settings' });
      store.putSync('clipboard_auto', value);
      store.flush();
    } catch (e) {
      // å­˜å‚¨å¤±è´¥ä¸å½±å“ä½¿ç”¨
    }
  }

  private addMember(): void {
    const name: string = this.newMemberName.trim();
    if (name.length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æˆå‘˜åç§°', duration: 1500 });
      return;
    }
    DatabaseHelper.getInstance().insertMember(name).then(() => {
      this.newMemberName = '';
      this.loadData();
      promptAction.showToast({ message: 'æ·»åŠ æˆåŠŸ', duration: 1500 });
    });
  }

  private deleteMember(member: FamilyMember): void {
    DatabaseHelper.getInstance().getMemberCount().then((count: number) => {
      if (count <= 1) {
        promptAction.showToast({ message: 'è‡³å°‘ä¿ç•™ä¸€ä¸ªå®¶åº­æˆå‘˜', duration: 1500 });
        return;
      }
      promptAction.showDialog({
        title: 'ç¡®è®¤åˆ é™¤',
        message: 'ç¡®å®šè¦åˆ é™¤å®¶åº­æˆå‘˜ "' + member.name + '" å—ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#999999' },
          { text: 'åˆ é™¤', color: '#FF3B30' }
        ]
      }).then((result: promptAction.ShowDialogSuccessResponse) => {
        if (result.index === 1) {
          DatabaseHelper.getInstance().deleteMember(member.id).then((success: boolean) => {
            if (success) {
              this.loadData();
              promptAction.showToast({ message: 'å·²åˆ é™¤', duration: 1500 });
            } else {
              promptAction.showToast({ message: 'è‡³å°‘ä¿ç•™ä¸€ä¸ªå®¶åº­æˆå‘˜', duration: 1500 });
            }
          });
        }
      });
    });
  }

  build() {
    Column() {
      Row() {
        Text('æˆ‘çš„')
          .fontSize(22).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
      }
      .width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })

      Scroll() {
        Column({ space: 16 }) {
          // å®¶åº­æˆå‘˜ç®¡ç†
          Column({ space: 12 }) {
            Text('å®¶åº­æˆå‘˜')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
            Row({ space: 8 }) {
              TextInput({ text: this.newMemberName, placeholder: 'è¾“å…¥æˆå‘˜åç§°ï¼Œå¦‚ï¼šçˆ¸çˆ¸' })
                .layoutWeight(1).height(40).fontSize(14).borderRadius(8)
                .onChange((value: string) => { this.newMemberName = value; })
              Button('æ·»åŠ ')
                .height(40).fontSize(14).fontColor(Color.White)
                .backgroundColor('#007DFF').borderRadius(8)
                .onClick(() => { this.addMember(); })
            }.width('100%')

            if (this.members.length === 0) {
              Text('æš‚æ— å®¶åº­æˆå‘˜ï¼Œè¯·æ·»åŠ ')
                .fontSize(13).fontColor($r('app.color.text_hint')).width('100%')
                .textAlign(TextAlign.Center).padding({ top: 12, bottom: 12 })
            } else {
              ForEach(this.members, (member: FamilyMember) => {
                Row() {
                  Text(member.name.substring(0, 1))
                    .fontSize(14).fontWeight(FontWeight.Bold).fontColor(Color.White)
                    .textAlign(TextAlign.Center).width(36).height(36).borderRadius(18)
                    .backgroundColor('#007DFF')
                  Text(member.name)
                    .fontSize(15).fontColor($r('app.color.text_primary')).layoutWeight(1).padding({ left: 12 })
                  Button('åˆ é™¤')
                    .height(32).fontSize(12).fontColor('#FF3B30')
                    .backgroundColor('#FFEDE9').borderRadius(6)
                    .onClick(() => { this.deleteMember(member); })
                }
                .width('100%').padding({ top: 8, bottom: 8 })
              }, (member: FamilyMember) => member.id.toString())
            }
          }
          .width('100%').padding(16).margin({ left: 16, right: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // åŠŸèƒ½å…¥å£ - ç›´æ¥å†…è”ï¼Œä¸é€šè¿‡builderä¼ å‚ï¼Œç¡®ä¿@Stateç»‘å®š
          Column({ space: 0 }) {
            Text('åŠŸèƒ½')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary'))
              .width('100%').padding({ bottom: 8 })

            // äº§å“å­—å…¸ - ç›´æ¥å¼•ç”¨this.dictCount
            Row() {
              Column({ space: 2 }) {
                Text('ğŸ“– äº§å“å­—å…¸').fontSize(15).fontColor($r('app.color.text_primary'))
                Text(this.dictCount + ' æ¡è®°å¿†æ•°æ®').fontSize(12).fontColor($r('app.color.text_hint'))
              }
              .layoutWeight(1).alignItems(HorizontalAlign.Start)
              Text('>').fontSize(16).fontColor($r('app.color.text_disabled'))
            }
            .width('100%').padding({ top: 12, bottom: 12 })
            .onClick(() => { router.pushUrl({ url: 'pages/ProductDictPage' }); })

            Divider().color($r('app.color.divider'))

            // å¥åº·æŠ¥è¡¨
            Row() {
              Column({ space: 2 }) {
                Text('ğŸ“Š å¥åº·æŠ¥è¡¨').fontSize(15).fontColor($r('app.color.text_primary'))
                Text('æŸ¥çœ‹è¯¦ç»†çƒ­é‡ä¸æµªè´¹åˆ†æ').fontSize(12).fontColor($r('app.color.text_hint'))
              }
              .layoutWeight(1).alignItems(HorizontalAlign.Start)
              Text('>').fontSize(16).fontColor($r('app.color.text_disabled'))
            }
            .width('100%').padding({ top: 12, bottom: 12 })
            .onClick(() => { router.pushUrl({ url: 'pages/HealthReportPage' }); })

            Divider().color($r('app.color.divider'))

            // æ•°æ®å¤‡ä»½
            Row() {
              Column({ space: 2 }) {
                Text('ğŸ’¾ æ•°æ®å¤‡ä»½').fontSize(15).fontColor($r('app.color.text_primary'))
                Text('å¯¼å‡º/å¯¼å…¥/æ¢å¤æ•°æ®').fontSize(12).fontColor($r('app.color.text_hint'))
              }
              .layoutWeight(1).alignItems(HorizontalAlign.Start)
              Text('>').fontSize(16).fontColor($r('app.color.text_disabled'))
            }
            .width('100%').padding({ top: 12, bottom: 12 })
            .onClick(() => { router.pushUrl({ url: 'pages/DataBackupPage' }); })

            Divider().color($r('app.color.divider'))

            // OCRè®°å½•
            Row() {
              Column({ space: 2 }) {
                Text('ğŸ” OCRè®°å½•').fontSize(15).fontColor($r('app.color.text_primary'))
                Text('æŸ¥çœ‹çƒ­é‡è¯†åˆ«å†å²').fontSize(12).fontColor($r('app.color.text_hint'))
              }
              .layoutWeight(1).alignItems(HorizontalAlign.Start)
              Text('>').fontSize(16).fontColor($r('app.color.text_disabled'))
            }
            .width('100%').padding({ top: 12, bottom: 12 })
            .onClick(() => { router.pushUrl({ url: 'pages/OcrRecordPage' }); })
          }
          .width('100%').padding(16).margin({ left: 16, right: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // è®¾ç½®
          Column({ space: 0 }) {
            Text('è®¾ç½®')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary'))
              .width('100%').padding({ bottom: 8 })

            Row() {
              Column({ space: 2 }) {
                Text('ğŸ“‹ å‰ªè´´æ¿è‡ªåŠ¨è§£æ').fontSize(15).fontColor($r('app.color.text_primary'))
                Text('å¼€å¯åè¿›å…¥åº”ç”¨æ—¶è‡ªåŠ¨è¯»å–å‰ªè´´æ¿å†…å®¹').fontSize(12).fontColor($r('app.color.text_hint'))
              }
              .layoutWeight(1).alignItems(HorizontalAlign.Start)
              Toggle({ type: ToggleType.Switch, isOn: this.clipboardAutoEnabled })
                .selectedColor('#007DFF')
                .onChange((isOn: boolean) => {
                  this.toggleClipboard(isOn);
                })
            }
            .width('100%').padding({ top: 12, bottom: 12 })
          }
          .width('100%').padding(16).margin({ left: 16, right: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // æ•°æ®ç»Ÿè®¡
          Column({ space: 12 }) {
            Text('æ•°æ®ç»Ÿè®¡')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
            Row() {
              Column({ space: 4 }) {
                Text(this.stats.total.toString())
                  .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#007DFF')
                Text('æ€»å…¥åº“').fontSize(12).fontColor($r('app.color.text_secondary'))
              }.alignItems(HorizontalAlign.Center).layoutWeight(1)
              Column({ space: 4 }) {
                Text(this.stats.active.toString())
                  .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#34C759')
                Text('åœ¨åº“').fontSize(12).fontColor($r('app.color.text_secondary'))
              }.alignItems(HorizontalAlign.Center).layoutWeight(1)
              Column({ space: 4 }) {
                Text(this.stats.consumed.toString())
                  .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#FF9500')
                Text('å·²é£Ÿç”¨').fontSize(12).fontColor($r('app.color.text_secondary'))
              }.alignItems(HorizontalAlign.Center).layoutWeight(1)
              Column({ space: 4 }) {
                Text(this.stats.wasted.toString())
                  .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#FF3B30')
                Text('å·²ä¸¢å¼ƒ').fontSize(12).fontColor($r('app.color.text_secondary'))
              }.alignItems(HorizontalAlign.Center).layoutWeight(1)
            }
            .width('100%')

            Divider().color($r('app.color.divider'))

            Row() {
              Text('å†…ç½®æ¡ç åº“')
                .fontSize(13).fontColor($r('app.color.text_secondary'))
              Blank()
              Text(this.builtinCount > 0 ? this.builtinCount + ' æ¡å·²åŠ è½½' : 'åŠ è½½ä¸­...')
                .fontSize(13).fontColor(this.builtinCount > 0 ? '#34C759' : $r('app.color.text_hint'))
            }
            .width('100%')
          }
          .width('100%').padding(16).margin({ left: 16, right: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)

          // å…³äº
          Column({ space: 12 }) {
            Text('å…³äº')
              .fontSize(15).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary')).width('100%')
            this.buildAboutRow('åº”ç”¨åç§°', 'é£Ÿå®‰è®° (Food Safe Note)')
            this.buildAboutRow('ç‰ˆæœ¬', 'v1.0.0')
            this.buildAboutRow('æ•°æ®å­˜å‚¨', 'ä»…æœ¬åœ°å­˜å‚¨ï¼Œç¦»çº¿å¯ç”¨')
            this.buildAboutRow('è®¾è®¡ç†å¿µ', 'æ™ºèƒ½ä¼˜å…ˆ Â· å…¨å‘˜å¹³æƒ Â· éšç§å®‰å…¨')
          }
          .width('100%').padding(16).margin({ left: 16, right: 16, bottom: 16 })
          .backgroundColor($r('app.color.card_background')).borderRadius(16)
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.page_background'))
  }

  @Builder
  buildAboutRow(label: string, value: string) {
    Row() {
      Text(label).fontSize(14).fontColor($r('app.color.text_secondary')).width(80)
      Text(value).fontSize(14).fontColor($r('app.color.text_primary')).layoutWeight(1)
    }
    .width('100%').padding({ top: 4, bottom: 4 })
  }
}
